<!DOCTYPE html>
<html>
    <head>
        <style>
            .note-row {
                display: grid;
                grid-template-columns: minmax(0, 3fr), minmax(0, 2fr);
                gap: 1rem;
                align-items: flex-start;
                margin-bottom: 1.5rem;
            }

            .note-text {
                margin: 0;
            }

            .sidenote {
                position: relative;
                font-size: 0.9rem;
            }

            .sidenote-content {
                overflow: hidden;
                transition: max-height 0.2s ease;
            }

            /* Visual cue for truncation (fade-out at bottom) */
            .sidenote.truncated:not(.expanded) .sidenote-content {
                position: relative;
            }

            .sidenote.truncated:not(.expanded) .sidenote-content::after {
                content: "";
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                height: 2rem;
                background: linear-gradient(to bottom, transparent, white);
            }

            /* Toggle button */
            .sidenote-toggle {
                margin-top: 0.25rem;
                padding: 0;
                border: none;
                background: none;
                color: #0077cc;
                cursor: pointer;
                font-size: 0.8rem;
            }

            /* Hide toggle if not truncated */
            .sidenote:not(.truncated) .sidenote-toggle {
                display: none;
            }

            /* Expanded state: remove max-height limit */
            .sidenote.expanded .sidenote-content {
                max-height: none !important;
            }

            .sidenote-expanded .sidenote-toggle::after {
                content: " (less)";
            }
        </style>
    </head>
    <body>
        <div class="note-row">
            <p class="note-text">
                This is a paragraph that may be shorter than its sidenote.
                The sidenote should appear to the right and truncate
                if it's taller.
            </p>
            <aside class="sidenote">
                <div class="sidenote-content">
                    This is a long sidenote. It might contain several
                    lines of text, links, or other inline content. When
                    it exceeds the height of the paragraph, it should be
                    visually truncated. Clicking it will expand to show
                    the full content without truncation.
                </div>
                <button class="sidenote-toggle" type="button">
                    More
                </button>
            </aside>
        </div>
        <div class="note-row">
            <p class="note-text">
                Another paragraph with its own sidenote. Each row is
                independent.
            </p>
            <aside class="sidenote">
                <div class="sidenote-content">
                    A short sidenote that doesn't need truncation.
                </div>
                <button class="sidenote-toggle" type="button">
                    More
                </button>
            </aside>
        </div>
    </body>
    <script>
        function updateSidenotes() {
            document.querySelectorAll('.note-row').forEach(row => {
                const para = row.querySelector('.note-text');
                const sidenote = row.querySelector('.sidenote');
                const content = row.querySelector('.sidenote-content');

                content.style.maxHeight = 'none';
                sidenote.classList.remove('truncated', 'expanded');

                const paraHeight = para.offsetHeight;
                const contentHeight = content.scrollHeight;

                if (contentHeight > paraHeight) {
                    content.style.maxHeight = paraHeight + 'px';
                    sidenote.classList.add('truncated');
                }
            });
        }

        window.addEventListener('load', updateSidenotes);
        window.addEventListener('resize', () => {
            updateSidenotes();
        })

        document.addEventListener('click', e => {
            const btn = e.target.closest('.sidenote-toggle');
            if (!btn) return;

            const sidenote = btn.closest('.sidenote');
            const content = sidenote.querySelector('.sidenote-content');

            if (sidenote.classList.contains('expanded')) {
                const row = sidenote.closest('.note-row');
                const para = row.querySelector('.note-text');
                const paraHeight = para.offsetHeight;
                content.style.maxHeight = paraHeight + 'px';
                sidenote.classList.remove('expanded');
                btn.textContent = 'More';
            } else {
                content.style.maxHeight = content.scrollHeight + 'px';
                sidenote.classList.add('expanded');
                btn.textContent = 'Less';
            }
        })
    </script>
</html>